<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soulink ¬∑ Quiz</title>
  <style>
    :root{
      --bg:#003c43; --fg:#eaf8f6; --muted:#bde5df; --accent:#00fdd8;
      --card:#014a52; --border:rgba(0,253,216,.35);
      --shadow:0 0 0 1px var(--border), 0 10px 30px rgba(0,253,216,.06), 0 0 40px rgba(0,253,216,.04) inset;
      --maxw:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    .container{max-width:var(--maxw);margin:0 auto;padding:24px}

    /* NAVBAR */
    .navbar{position:sticky;top:0;z-index:50;background:rgba(0,60,67,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .navbar::after{content:"";position:absolute;left:0;right:0;bottom:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transform:scaleX(.2);transition:opacity .25s,transform .25s}
    .navbar.scrolled::after{opacity:.9;transform:scaleX(1)}
    .nav-inner{display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
    .brand{font-weight:800;color:var(--accent)}
    .nav-links{display:flex;gap:14px;flex-wrap:wrap}
    .nav-links a{padding:8px 10px;border-radius:10px;border:1px solid transparent;transition:box-shadow .15s,border-color .15s}
    .nav-links a:hover{border-color:var(--border);box-shadow:0 0 0 1px var(--border),0 0 16px rgba(0,253,216,.18)}
    .nav-links a:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .hamburger{display:none}
    .hamburger button{appearance:none;background:transparent;border:1px solid var(--border);color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer}
    @media(max-width:800px){.nav-links{display:none}.hamburger{display:block}}

    /* DRAWER */
    .drawer{position:fixed;inset:0;display:none;z-index:100}
    .drawer.open{display:block}
    .drawer .backdrop{position:absolute;inset:0;background:rgba(0,60,67,.96)}
    .drawer .panel{position:absolute;top:0;right:0;width:min(82vw,360px);height:100%;background:#003c43;border-left:1px solid var(--border);padding:18px;transform:translateX(100%);transition:transform .25s}
    .drawer.open .panel{transform:translateX(0)}
    @media (prefers-reduced-motion: reduce){.drawer .panel{transition:none}}
    body.no-scroll{overflow:hidden}
    .drawer .panel a{display:block;padding:14px 12px;border-radius:12px;min-height:44px}
    .drawer .panel a:hover{background:rgba(0,253,216,.08);box-shadow:0 0 0 1px var(--border),0 0 14px rgba(0,253,216,.18)}

    /* CARDS */
    .card{background:linear-gradient(180deg,rgba(1,74,82,.74),rgba(1,74,82,.56));border:1px solid var(--border);box-shadow:var(--shadow);border-radius:18px;padding:18px;margin:22px 0}
    .card h2{margin:0 0 8px}
    .card small{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:760px){.row{grid-template-columns:1fr}}

    label{display:block;font-weight:600;margin:6px 0 6px}
    input[type="text"], textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:rgba(0,253,216,.06);color:var(--fg)}
    textarea{min-height:120px;resize:vertical}
    .hint{color:var(--muted);font-size:.9rem;margin-top:6px}
    .counter{color:var(--muted);font-size:.9rem;text-align:right;margin-top:6px}

    /* Chips */
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(0,253,216,.06);font-size:.95rem;min-height:44px;cursor:pointer}
    .chip[aria-pressed="true"]{background:rgba(0,253,216,.16);box-shadow:inset 0 0 22px rgba(0,253,216,.12)}
    .chip .check{font-size:1rem}
    .chip.gem{background:rgba(0,253,216,.1);box-shadow:inset 0 0 18px rgba(0,253,216,.08)}
    .ico{width:1.1rem;display:inline-block;text-align:center}
    .muted{color:var(--muted)}
    .collapsible{overflow:hidden;transition:max-height .2s ease,opacity .2s ease}
    .hidey{max-height:0 !important;opacity:0 !important;margin:0 !important;padding-top:0 !important;padding-bottom:0 !important;border-width:0 !important}
    @media (prefers-reduced-motion: reduce){.collapsible{transition:none}}

    /* Actions */
    .actions{display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;margin:28px 0}
    .btn{appearance:none;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;min-height:44px}
    .btn.primary{background:var(--accent);color:#003136}
    .btn.ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
    .btn.outline{background:transparent;color:var(--fg);border:1px solid var(--border)}
    .btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    @media(max-width:760px){.actions{flex-direction:column}.actions .btn{width:100%}}

    footer{margin:40px 0 16px;padding-top:16px;border-top:1px solid var(--border);color:var(--muted);font-size:.95rem}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar" role="navigation" aria-label="Main">
    <div class="nav-inner">
      <div class="brand">Soulink</div>
      <div class="nav-links" aria-label="Primary">
        <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="quiz.html">Quiz</a></li>
        <li><a href="edit-profile.html">Edit Profile</a></li>
        <li><a href="my-soul.html">My Soul</a></li>
        <li><a href="soul-chart.html">Soul Chart</a></li>
        <li><a href="soul-coach.html">Soul Coach</a></li>
        <li><a href="match.html">Match</a></li>
        <li><a href="friends.html">Friends</a></li>
        <li><a href="results.html">Results</a></li>
        <li><a href="login.html">Log In</a></li>
        <li><a href="signup.html">Sign Up</a></li>
        <li><a href="logout.html">Log Out</a></li>
       </ul>
      </div>
      <div class="hamburger"><button id="openDrawer" aria-label="Open menu">‚ò∞ Menu</button></div>
    </div>
  </nav>

  <!-- MOBILE DRAWER -->
  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="backdrop" id="drawerBackdrop" tabindex="-1" aria-label="Close"></div>
    <aside class="panel" role="dialog" aria-modal="true" aria-label="Navigation">
      <a href="index.html">Home</a>
      <a href="quiz.html" aria-current="page">Quiz</a>
      <a href="edit-profile.html">Edit Profile</a>
      <a href="my-soul.html">My Soul</a>
      <a href="soul-chart.html">Soul Chart</a>
      <a href="soul-coach.html">Soul Coach</a>
      <a href="match.html">Match</a>
      <a href="friends.html">Friends</a>
      <a href="result.htmls">Results</a>
      <a href="login.html">Log In</a>
      <a href="signup.html">Sign Up</a>
      <a href="#" id="logoutLinkMobile">Log Out</a>
      <button class="btn ghost" id="closeDrawer" style="margin-top:8px">Close</button>
    </aside>
  </div>

  <div class="container" id="top">
    <!-- Basic Info -->
    <section class="card" id="card-basic">
      <h2>üéÇ Basic Info</h2>
      <small>Tell us a little about you. Simple and gentle.</small>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="name">Name</label>
          <input id="name" type="text" placeholder="Your name" />
        </div>
        <div>
          <label for="country">Country</label>
          <input id="country" type="text" placeholder="Country" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="birthday">Birth date</label>
          <input id="birthday" type="text" inputmode="numeric" pattern="[0-9\-]*" placeholder="1972-11-22" aria-describedby="birthdayHint" />
          <div id="birthdayHint" class="hint">Example: 1993-02-24 (or type 19930224)</div>
        </div>
        <div id="hwWrap" class="row" style="grid-template-columns:1fr 1fr;gap:14px;padding:0">
          <div id="heightWrap" class="collapsible">
            <label for="height">Height (cm)</label>
            <input id="height" type="text" inputmode="numeric" placeholder="Optional" />
          </div>
          <div id="weightWrap" class="collapsible">
            <label for="weight">Weight (kg)</label>
            <input id="weight" type="text" inputmode="numeric" placeholder="Optional" />
          </div>
          <div id="hwHint" class="hint" style="grid-column:1/-1">Optional. Some people care about this in relationships.</div>
        </div>
      </div>
    </section>

    <!-- Connection -->
    <section class="card" id="card-connection">
      <h2>ü§ù Connection</h2>
      <small>What kind of connections are you open to?</small>
      <div class="chips" id="connectionChips" style="margin-top:10px"></div>
      <div id="connHelper" class="hint">Fields adjust to your choice. Friendship focuses on values & hobbies; Romantic adds identity and preferences. LGBTQ+ inclusive.</div>
    </section>

    <!-- Love Languages -->
    <section class="card" id="card-love">
      <h2>üíñ Love Languages</h2>
      <small>Choose one or more. The first becomes your Primary.</small>
      <div class="chips" id="loveChips" style="margin-top:10px"></div>
      <div class="muted" style="margin-top:8px">
        <div><strong>Words of Affirmation</strong> ‚Äî Kind, encouraging words that express love.</div>
        <div><strong>Acts of Service</strong> ‚Äî Helpful actions that ease your load and show care.</div>
        <div><strong>Receiving Gifts</strong> ‚Äî Thoughtful tokens that say ‚ÄúI remembered you.‚Äù</div>
        <div><strong>Quality Time</strong> ‚Äî Focused, undivided attention and deep conversations.</div>
        <div><strong>Physical Touch</strong> ‚Äî Hugs, hand-holding, and gentle physical closeness.</div>
      </div>
    </section>

    <!-- Gender Identity -->
    <section class="card" id="card-gender">
      <h2>üí´ Your Gender Identity</h2>
      <small>How you identify yourself.</small>
      <div class="chips" id="genderIdChips" style="margin-top:10px"></div>
      <div id="genderSelfMount"></div>
    </section>

    <!-- Who you want to connect with -->
    <section class="card" id="card-connect">
      <h2>üíõ Who you want to connect with</h2>
      <small>Choose who you‚Äôd like to connect with. For friendship, you can keep it open.</small>

      <!-- Friendship simplified -->
      <div id="connectFriendWrap" class="collapsible" style="margin-top:10px">
        <div class="chips" id="friendConnectChips"></div>
        <div class="chips" id="friendPairingChips" style="margin-top:10px;display:none"></div>
        <div id="friendConnectHint" class="hint">For friendship, keeping it open is perfect.</div>
      </div>

      <!-- Romantic/Both detailed -->
      <div id="connectDetailedWrap" class="collapsible" style="margin-top:10px">
        <div class="chips" id="connectWithChips"></div>
        <div id="connectWithCustomMount"></div>
        <div class="hint" id="pairingQuickHint" style="margin-top:10px">Quick pairing suggestions:</div>
        <div class="chips" id="pairingQuickChips" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Relationship Preferences (Romantic/Both only) -->
    <section class="card collapsible" id="relationshipCard">
      <h2>üíû Relationship Preferences</h2>
      <small>Tell us more about your romantic preferences.</small>

      <div style="margin-top:12px">
        <label>Body Type Preference</label>
        <div class="chips" id="bodyTypeChips"></div>
        <div class="hint">Optional. Helps us suggest partners more aligned with your preference.</div>
      </div>

      <div style="margin-top:12px">
        <label>Age Range</label>
        <div class="hint">Preferred partner age range.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:8px 0">
          <div>
            <div class="muted">Min: <span id="minAgeValue">20</span></div>
            <input id="minAge" type="range" min="18" max="80" step="1" aria-label="Minimum age">
          </div>
          <div>
            <div class="muted">Max: <span id="maxAgeValue">60</span></div>
            <input id="maxAge" type="range" min="18" max="80" step="1" aria-label="Maximum age">
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Lifestyle Preferences</label>
        <div class="chips" id="lifestyleChips"></div>
      </div>
    </section>

    <!-- Orientation (Romantic/Both) -->
    <section class="card collapsible" id="orientationCard">
      <h2>üåà Orientation</h2>
      <div class="chips" id="orientationChips" style="margin-top:10px"></div>
    </section>

    <!-- Hobbies -->
    <section class="card" id="card-hobbies">
      <h2>üåø Hobbies</h2>
      <div class="chips" id="hobbyChips" style="margin-top:10px"></div>
      <div class="row" style="margin-top:8px">
        <div style="grid-column:1/-1">
          <input id="hobbyInput" type="text" placeholder="Add custom hobby‚Ä¶" />
        </div>
      </div>
    </section>

    <!-- Values -->
    <section class="card" id="card-values">
      <h2>üíé Values</h2>
      <div class="chips" id="valueChips" style="margin-top:10px"></div>
      <div class="row" style="margin-top:8px">
        <div style="grid-column:1/-1">
          <input id="valueInput" type="text" placeholder="Add custom value‚Ä¶" />
        </div>
      </div>
    </section>

    <!-- Boundaries -->
    <section class="card" id="card-boundaries">
      <h2>üïäÔ∏è Boundaries</h2>
      <textarea id="boundaries" placeholder="What behaviors are not aligned with your soul? üåë"></textarea>
      <div class="counter"><span id="boundariesCount">0</span>/300</div>
    </section>

    <!-- About Me -->
    <section class="card" id="card-about">
      <h2>üìú About Me</h2>
      <textarea id="aboutMe" placeholder="Tell us about your soul journey‚Ä¶ ‚ú®"></textarea>
      <div class="counter"><span id="aboutCount">0</span>/500</div>
    </section>

    <section class="actions">
      <button id="backHome" class="btn ghost">Back ‚Üê Home</button>
      <button id="nextEdit" class="btn primary">Next ‚Üí My Soul</button>
    </section>

    <footer>¬© 2025 Soulink.global | Created with love by Soulink Team</footer>
  </div>

  <script>
    (()=>{

      /* ========== DOM refs ========== */
      const $=s=>document.querySelector(s);
      const ui={
        // basics
        name:$('#name'), country:$('#country'), birthday:$('#birthday'), birthdayHint:$('#birthdayHint'),
        height:$('#height'), weight:$('#weight'), heightWrap:$('#heightWrap'), weightWrap:$('#weightWrap'), hwHint:$('#hwHint'),

        // connection
        connectionChips:$('#connectionChips'), connHelper:$('#connHelper'),

        // love languages
        loveChips:$('#loveChips'),

        // gender/connect with
        genderIdChips:$('#genderIdChips'), genderSelfMount:$('#genderSelfMount'),
        connectWithChips:$('#connectWithChips'), connectWithCustomMount:$('#connectWithCustomMount'),
        friendConnectChips:$('#friendConnectChips'), friendConnectWrap:$('#connectFriendWrap'),
        friendPairingChips:$('#friendPairingChips'),
        connectDetailedWrap:$('#connectDetailedWrap'), friendConnectHint:$('#friendConnectHint'),

        // relationship pref
        relationshipCard: $('#relationshipCard'),
        bodyTypeChips: $('#bodyTypeChips'),
        lifestyleChips: $('#lifestyleChips'),
        minAge: $('#minAge'), maxAge: $('#maxAge'),
        minAgeValue: $('#minAgeValue'), maxAgeValue: $('#maxAgeValue'),
        pairingQuickChips: $('#pairingQuickChips'), pairingQuickHint:$('#pairingQuickHint'),

        // orientation
        orientationChips:$('#orientationChips'), orientationCard:$('#orientationCard'),

        // hobbies/values
        hobbyChips:$('#hobbyChips'), valueChips:$('#valueChips'),
        hobbyInput:$('#hobbyInput'), valueInput:$('#valueInput'),

        // long text
        boundaries:$('#boundaries'), boundariesCount:$('#boundariesCount'),
        aboutMe:$('#aboutMe'), aboutCount:$('#aboutCount'),

        // actions
        backHome:$('#backHome'), nextEdit:$('#nextEdit'),

        // nav
        openDrawer:$('#openDrawer'), closeDrawer:$('#closeDrawer'),
        drawer:$('#drawer'), drawerBackdrop:$('#drawerBackdrop'),
        logout:$('#logoutLink'), logoutM:$('#logoutLinkMobile'),
        navbar:document.querySelector('.navbar'),

        // announcer
        announce: (function(){ const s=document.createElement('div'); s.setAttribute('aria-live','polite'); s.className='muted'; s.style.height='1px'; s.style.overflow='hidden'; document.body.appendChild(s); return s; })()
      };

      /* ========== Data helpers ========== */
      const getData = ()=>{ try{ const raw=localStorage.getItem('soulQuiz'); return raw? JSON.parse(raw): {}; } catch { return {}; } };
      const setData = (patch)=>{ const cur=getData(); const merged={...cur, ...patch}; localStorage.setItem('soulQuiz', JSON.stringify(merged)); return merged; };
      const list = v => Array.isArray(v) ? v : (typeof v==='string' ? v.split(/[\n,]/).map(s=>s.trim()).filter(Boolean) : []);

      /* ========== Defaults ========== */
      const DEFAULT_HOBBIES = ['Travel','Yoga','Music','Reading','Gym','Running','Dancing','Art','Photography','Cooking','Baking','Hiking','Gardening','Meditation','Movies','Gaming'];
      const DEFAULT_VALUES  = ['Honesty','Kindness','Loyalty','Freedom','Creativity','Growth','Family','Adventure','Compassion','Integrity','Humor','Respect','Balance','Spirituality','Curiosity'];

      const BODY_TYPES = ['Slim','Athletic','Average','Curvy','No preference'];
      const LIFESTYLE_PREFS = ['Open to all','Smokes','Doesn‚Äôt smoke','Drinks socially','Doesn‚Äôt drink','Fitness-oriented','Spiritual','Family-oriented','No preference'];

      const LOVE_LIST = ['Words of Affirmation','Acts of Service','Receiving Gifts','Quality Time','Physical Touch'];

      /* ========== Small utils ========== */
      const hobbyIcon=(label)=>{ const s=(label||'').toLowerCase();
        const map=[['travel','‚úàÔ∏è'],['yoga','üßò'],['music','üéµ'],['reading','üìö'],['books','üìö'],['gym','üèãÔ∏è'],['running','üèÉ'],['dance','üíÉ'],['art','üé®'],['photo','üì∑'],['cook','üç≥'],['bake','üßÅ'],['hiking','ü•æ'],['garden','üåø'],['meditation','üïØÔ∏è'],['movie','üé¨'],['game','üéÆ']];
        for(const [k,ico] of map){ if(s.includes(k)) return ico; } return '‚ú®';
      };
      const chip = (label)=>{ const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=label; b.setAttribute('aria-pressed','false'); return b; };
      const setVis = (el, show)=>{ if(!el) return; el.classList.toggle('hidey', !show); el.style.maxHeight = show? (el.scrollHeight+'px') : '0px'; if(show) el.style.opacity='1'; };
      const announce = (msg)=>{ ui.announce.textContent=''; setTimeout(()=> ui.announce.textContent=msg, 25); };

      /* ========== Birthday format & validate ========== */
      function formatBirthOnInput(){
        const v=ui.birthday.value.replace(/[^\d-]/g,'');
        const digits=v.replace(/\D/g,'');
        if(digits.length>=5 && !v.includes('-')){
          const y=digits.slice(0,4), m=digits.slice(4,6), d=digits.slice(6,8);
          ui.birthday.value = [y,m,d].filter(Boolean).join('-');
        }
      }
      function validateBirthday(){
        const raw=ui.birthday.value.trim();
        const digits=raw.replace(/\D/g,'');
        if(digits.length!==8){ return; } // hint already below
        const y=+digits.slice(0,4), m=+digits.slice(4,6), d=+digits.slice(6,8);
        const ok = y>=1900 && y<=2035 && m>=1 && m<=12 && d>=1 && d<=31;
        if(ok){ setData({birthday: `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`}); }
      }

      /* ========== Connection ========== */
      function renderConnection(type){
        const opts=['friendship','romantic','both'];
        ui.connectionChips.innerHTML='';
        const cur=type||'friendship';
        opts.forEach(lbl=>{
          const el=chip(lbl);
          if(cur===lbl){ el.setAttribute('aria-pressed','true'); el.classList.add('selected'); }
          el.addEventListener('click', ()=>{
            const d=setData({connectionType:lbl});
            renderConnection(lbl);
            updateVisibility(lbl);
          });
          ui.connectionChips.appendChild(el);
        });
      }

      /* ========== Love Languages (multi & primary) ========== */
      function renderLove(arr){
        const selected = Array.isArray(arr)? [...arr] : list(arr);
        ui.loveChips.innerHTML='';
        LOVE_LIST.forEach(lbl=>{
          const el=chip(lbl);
          const on = selected.map(v=>v.toLowerCase()).includes(lbl.toLowerCase());
          el.setAttribute('aria-pressed', on?'true':'false');
          if(on && selected[0] && selected[0].toLowerCase()===lbl.toLowerCase()){
            el.innerHTML = `<span class="check">‚úì</span> ${lbl} <small class="muted">¬∑ Primary</small>`;
            el.classList.add('selected');
          } else if(on){
            el.innerHTML = `<span class="check">‚úì</span> ${lbl}`;
            el.classList.add('selected');
          }
          el.addEventListener('click', ()=>{
            let d = list(getData().loveLanguages||getData().loveLanguage);
            const idx = d.map(v=>v.toLowerCase()).indexOf(lbl.toLowerCase());
            if(idx>-1){ d.splice(idx,1); }
            else{
              if(d.length===0) d = [lbl]; else d.push(lbl);
            }
            setData({ loveLanguages: d });
            renderLove(d);
          });
          ui.loveChips.appendChild(el);
        });
      }

      /* ========== Gender Identity ========== */
      function renderGenderIdentity(d){
        const opts=['Woman','Man','Non-binary','Prefer not to say','Self-describe'];
        const cur=d.genderIdentity||'';
        ui.genderIdChips.innerHTML='';
        opts.forEach(lbl=>{
          const el=chip(lbl);
          const on = (cur===lbl);
          if(on){ el.classList.add('selected'); el.setAttribute('aria-pressed','true'); }
          el.addEventListener('click', ()=>{
            const nd = setData({ genderIdentity: lbl==='Self-describe'? null : lbl });
            renderGenderIdentity(getData());
          });
          ui.genderIdChips.appendChild(el);
        });
        // self-describe input
        const isSelf = (d.genderIdentity==null) && (d.genderSelf||'')!=='' || (cur==='Self-describe');
        ui.genderSelfMount.innerHTML='';
        if((cur==='Self-describe') || d.genderSelf){
          const wrap=document.createElement('div');
          wrap.innerHTML = `<label>Self-describe</label><input id="genderSelf" type="text" placeholder="Type here‚Ä¶" />`;
          ui.genderSelfMount.appendChild(wrap);
          const input=wrap.querySelector('#genderSelf');
          input.value = d.genderSelf||'';
          input.addEventListener('input',()=> setData({genderSelf: input.value.trim()}));
        }
      }

      /* ========== Connect With (Romantic/Both) ========== */
      function renderConnectWith(d){
        const opts=['Women','Men','Non-binary','Open to all','Custom preference'];
        const cur = d.connectWith||'Open to all';
        ui.connectWithChips.innerHTML='';
        opts.forEach(lbl=>{
          const el=chip(lbl);
          const on = (cur===lbl);
          if(on){ el.classList.add('selected'); el.setAttribute('aria-pressed','true'); }
          el.addEventListener('click', ()=>{
            const patch = { connectWith: lbl };
            if(lbl!=='Custom preference') patch.connectWithCustom = null;
            setData(patch);
            renderConnectWith(getData());
          });
          ui.connectWithChips.appendChild(el);
        });
        // custom
        ui.connectWithCustomMount.innerHTML='';
        if(cur==='Custom preference'){
          const wrap=document.createElement('div');
          wrap.innerHTML = `<label>Custom preference</label><input id="connectWithCustom" type="text" placeholder="e.g., Women & Non-binary" />`;
          ui.connectWithCustomMount.appendChild(wrap);
          const input=wrap.querySelector('#connectWithCustom');
          input.value = d.connectWithCustom||'';
          input.addEventListener('input',()=> setData({connectWithCustom: input.value.trim()}));
        }
      }

      /* ========== Friend Connect (Friendship) ========== */
      function renderFriendConnect(d){
        const choices=['Open to all','Same gender','No preference'];
        ui.friendConnectChips.innerHTML='';
        const current=(d.connectWith||'Open to all');

        choices.forEach(lbl=>{
          const el=chip(lbl);
          const on = (current===lbl);
          if(on){ el.classList.add('selected','primary'); el.setAttribute('aria-pressed','true'); }
          el.addEventListener('click',()=>{
            setData({connectWith:lbl});
            renderFriendConnect(getData());
          });
          ui.friendConnectChips.appendChild(el);
        });

        // detailed pairing when "Same gender"
        renderFriendPairing(getData());
      }

      function renderFriendPairing(d){
        const show = ((d.connectWith||'Open to all')==='Same gender');
        ui.friendPairingChips.style.display = show ? '' : 'none';
        if(!show){ ui.friendPairingChips.innerHTML=''; return; }

        const options = ['Women ‚Üî Women','Men ‚Üî Men','Non-binary ‚Üî Non-binary'];
        const cur = d.connectWithDetail || '';
        ui.friendPairingChips.innerHTML='';

        options.forEach(lbl=>{
          const el = chip(lbl);
          const on = (cur===lbl);
          if(on){ el.classList.add('selected','primary'); el.setAttribute('aria-pressed','true'); }
          el.addEventListener('click', ()=>{
            setData({ connectWithDetail: lbl });
            renderFriendPairing(getData());
          });
          ui.friendPairingChips.appendChild(el);
        });
      }

      /* ========== Orientation (Romantic/Both) ========== */
      function renderOrientation(d){
        const listO = ['Heterosexual','Gay','Lesbian','Bisexual','Pansexual','Asexual','Queer','Questioning','Prefer not to say'];
        ui.orientationChips.innerHTML='';
        listO.forEach(lbl=>{
          const el=chip(lbl);
          const on = (d.orientation===lbl);
          if(on){ el.classList.add('selected','primary'); el.setAttribute('aria-pressed','true'); }
          el.addEventListener('click',()=>{ setData({orientation:lbl}); renderOrientation(getData()); });
          ui.orientationChips.appendChild(el);
        });
      }

      /* ========== Relationship preferences ========== */
      function getRel(){ const d=getData(); return d.relationship || {}; }
      function setRel(patch){ const d=getData(); const rel={...(d.relationship||{}), ...patch}; setData({relationship:rel}); return rel; }

      function renderRelChips(container, options, selectedArr, relKey, {exclusive=null}={}){
        container.innerHTML='';
        const selLower=(selectedArr||[]).map(v=>String(v).toLowerCase());
        options.forEach(lbl=>{
          const el=chip(lbl);
          const on=selLower.includes(lbl.toLowerCase());
          el.setAttribute('aria-pressed', on?'true':'false');
          if(on){ el.classList.add('selected'); el.innerHTML=`<span class="check">‚úì</span> ${lbl}`; } else { el.textContent=lbl; }
          el.addEventListener('click', ()=>{
            const cur = getRel();
            let arr = Array.isArray(cur[relKey])? [...cur[relKey]] : [];
            const idx = arr.map(v=>String(v).toLowerCase()).indexOf(lbl.toLowerCase());
            let nowOn=false;
            if(idx>-1){ arr.splice(idx,1); nowOn=false; }
            else{
              if(exclusive && lbl===exclusive){ arr=[lbl]; }
              else{
                if(exclusive){ arr = arr.filter(v=>v!==exclusive); }
                arr.push(lbl);
              }
              nowOn=true;
            }
            setRel({ [relKey]: arr });
            renderRelChips(container, options, arr, relKey, {exclusive});
            announce(`${nowOn?'Added to':'Removed from'} ${relKey}`);
          });
          container.appendChild(el);
        });
      }

      function bindAge(){
        if(!ui.minAge || !ui.maxAge) return;
        const rel = getRel();
        let [min,max] = Array.isArray(rel.ageRange) ? rel.ageRange : [20,60];
        min = Math.max(18, Math.min(80, Number(min)||20));
        max = Math.max(18, Math.min(80, Number(max)||60));
        if(min>max){ [min,max] = [max,min]; }
        ui.minAge.value = String(min); ui.maxAge.value = String(max);
        ui.minAgeValue.textContent = min; ui.maxAgeValue.textContent = max;

        const update = ()=>{
          let a = Number(ui.minAge.value)||20;
          let b = Number(ui.maxAge.value)||60;
          if(a>b){
            if(document.activeElement===ui.minAge){ b=a; ui.maxAge.value=b; }
            else { a=b; ui.minAge.value=a; }
          }
          a = Math.max(18, Math.min(80, a));
          b = Math.max(18, Math.min(80, b));
          ui.minAgeValue.textContent = a; ui.maxAgeValue.textContent = b;
          setRel({ ageRange: [a,b] });
        };
        ui.minAge.oninput = update;
        ui.maxAge.oninput = update;
      }

      function renderRelationship(){
        const rel = getRel();
        renderRelChips(ui.bodyTypeChips, BODY_TYPES, Array.isArray(rel.bodyType)? rel.bodyType: [], 'bodyType', {exclusive:'No preference'});
        renderRelChips(ui.lifestyleChips, LIFESTYLE_PREFS, Array.isArray(rel.lifestyle)? rel.lifestyle: [], 'lifestyle', {exclusive:'Open to all'});
        bindAge();
      }

      /* ========== Hobbies & Values (toggle + custom) ========== */
      function getOptions(defaults, keyCustom){
        const d=getData();
        const customs = list(d[keyCustom]);
        const merged = [...defaults];
        customs.forEach(v=>{ if(!merged.map(x=>x.toLowerCase()).includes(v.toLowerCase())) merged.push(v); });
        return {merged, customs};
      }

      function renderToggles(container, selectedArr, defaults, {gem=false, icon=false, key}){
        const {merged} = getOptions(defaults, key==='hobbies'?'customHobbies':'customValues');
        const selected = Array.isArray(selectedArr) ? [...selectedArr] : list(selectedArr);

        container.innerHTML='';
        merged.forEach(lbl=>{
          const btn=document.createElement('button');
          btn.type='button'; btn.className='chip' + (gem?' gem':''); btn.setAttribute('aria-pressed','false');
          if(icon){ btn.innerHTML = `<span class="ico">${hobbyIcon(lbl)}</span><span>${lbl}</span>`; } else { btn.textContent=lbl; }

          const on = selected.map(v=>v.toLowerCase()).includes(lbl.toLowerCase());
          if(on){ btn.classList.add('selected'); btn.setAttribute('aria-pressed','true'); if(!icon) btn.innerHTML = `<span class="check">‚úì</span> ${lbl}`; }

          btn.addEventListener('click', ()=>{
            let data = list(getData()[key]);
            const i = data.map(v=>v.toLowerCase()).indexOf(lbl.toLowerCase());
            if(i>-1) data.splice(i,1); else data.push(lbl);
            setData({ [key]: data });
            renderToggles(container, data, defaults, {gem, icon, key});
            announce(`${i>-1?'Removed from':'Added to'} ${key}`);
          });

          container.appendChild(btn);
        });
      }

      function addCustom(inputEl, key, container, opts, defaults){
        inputEl.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){
            const raw=inputEl.value.trim().replace(/\s+/g,' ');
            if(!raw) return;
            const d=getData();
            const listCustom = list(d[key==='hobbies'?'customHobbies':'customValues']);
            const all = new Set([...defaults.map(x=>x.toLowerCase()), ...listCustom.map(x=>x.toLowerCase())]);
            if(!all.has(raw.toLowerCase())){
              const field = key==='hobbies'?'customHobbies':'customValues';
              const updated = [...listCustom, raw];
              setData({ [field]: updated, [key]: [...list(d[key]||[]), raw] });
            } else {
              setData({ [key]: [...list(d[key]||[]), raw] });
            }
            inputEl.value='';
            renderToggles(container, list(getData()[key]), defaults, opts);
          }
        });
      }

      /* ========== Visibility by mode ========== */
      function updateVisibility(mode){
        const d=getData();
        const m = mode || d.connectionType || 'friendship';
        const romantic = (m==='romantic'|| m==='both');
        setData({useRomanticFilters: romantic});

        // defaults for friendship
        if(!romantic){
          if(!d.genderIdentity && !d.genderSelf){ setData({genderIdentity:'Prefer not to say'}); }
          if(!d.connectWith){ setData({connectWith:'Open to all'}); }
        }

        setVis(ui.orientationCard, romantic);
        setVis(ui.connectDetailedWrap, romantic);
        setVis(ui.friendConnectWrap, !romantic);
        setVis(ui.relationshipCard, romantic);

        // height/weight shown only in romantic/both
        setVis(ui.heightWrap, romantic);
        setVis(ui.weightWrap, romantic);
        setVis(ui.hwHint, romantic);

        ui.friendConnectHint && (ui.friendConnectHint.style.opacity = !romantic? 1 : 0.6);

        if(romantic){ announce(m==='both' ? 'All options available.' : 'Romantic details revealed.'); }
        else { announce('Friendship mode ‚Äî romantic details hidden.'); }
      }

      /* ========== Counters & Basics binding ========== */
      function bindCounters(){
        const maxB=300, maxA=500;
        const upd=()=>{
          ui.boundariesCount.textContent = Math.min(maxB, ui.boundaries.value.length);
          ui.aboutCount.textContent = Math.min(maxA, ui.aboutMe.value.length);
        };
        ui.boundaries.addEventListener('input',()=>{
          if(ui.boundaries.value.length>maxB) ui.boundaries.value=ui.boundaries.value.slice(0,maxB);
          setData({boundaries:ui.boundaries.value}); upd();
        });
        ui.aboutMe.addEventListener('input',()=>{
          if(ui.aboutMe.value.length>maxA) ui.aboutMe.value=ui.aboutMe.value.slice(0,maxA);
          setData({aboutMe:ui.aboutMe.value}); upd();
        });
        upd();
      }

      function populateBasics(d){
        ui.name.value=d.name||''; ui.country.value=d.country||''; ui.birthday.value=d.birthday||'';
        ui.height.value=d.height||''; ui.weight.value=d.weight||'';
      }
      function bindBasics(){
        ui.name.addEventListener('input',()=> setData({name:ui.name.value.trim()}));
        ui.country.addEventListener('input',()=> setData({country:ui.country.value.trim()}));
        ui.birthday.addEventListener('input', formatBirthOnInput);
        ui.birthday.addEventListener('blur', validateBirthday);
        ui.height.addEventListener('input',()=> setData({height:ui.height.value.replace(/[^\d.]/g,'')}));
        ui.weight.addEventListener('input',()=> setData({weight:ui.weight.value.replace(/[^\d.]/g,'')}));
      }

      /* ========== Pairing quick suggestions (Romantic/Both) ========== */
      function renderPairingQuick(d){
        const mode = d.connectionType || 'friendship';
        const romantic = (mode==='romantic'||mode==='both');
        if(ui.pairingQuickHint) ui.pairingQuickHint.style.display = romantic ? '' : 'none';
        ui.pairingQuickChips.style.display = romantic ? '' : 'none';
        if(!romantic){ ui.pairingQuickChips.innerHTML=''; return; }

        const gi = d.genderIdentity || null;
        const combos = gi==='Woman'      ? [['Woman','Women'],['Woman','Men'],['Woman','Non-binary']]
                     : gi==='Man'        ? [['Man','Women'],['Man','Men'],['Man','Non-binary']]
                     : gi==='Non-binary' ? [['Non-binary','Women'],['Non-binary','Men'],['Non-binary','Non-binary']]
                     : [['Woman','Men'],['Woman','Women'],['Man','Men'],['Non-binary','Non-binary']];

        ui.pairingQuickChips.innerHTML='';
        combos.forEach(([me, seek])=>{
          const label = `${me} ‚Üî ${seek}`;
          const el = chip(label);
          const selected = (d.genderIdentity===me) && (d.connectWith===seek);
          if(selected) el.classList.add('selected','primary');
          el.addEventListener('click', ()=>{
            setData({ genderIdentity: me, connectWith: seek, connectWithCustom: null });
            renderGenderIdentity(getData());
            renderConnectWith(getData());
            renderPairingQuick(getData());
          });
          ui.pairingQuickChips.appendChild(el);
        });
      }

      /* ========== Render all ========== */
      function renderAll(){
        const d=getData();
        populateBasics(d);
        renderConnection(d.connectionType);
        renderLove(d.loveLanguages);
        renderGenderIdentity(d);
        renderConnectWith(d);
        renderFriendConnect(d);
        renderPairingQuick(d);
        renderOrientation(d);
        renderRelationship();

        renderToggles(ui.hobbyChips, list(d.hobbies), DEFAULT_HOBBIES, {icon:true, key:'hobbies'});
        renderToggles(ui.valueChips, list(d.values), DEFAULT_VALUES, {gem:true, key:'values'});

        ui.boundaries.value=d.boundaries||'';
        ui.aboutMe.value=d.aboutMe||'';
        ui.boundariesCount.textContent=String((d.boundaries||'').length);
        ui.aboutCount.textContent=String((d.aboutMe||'').length);

        updateVisibility(d.connectionType);
        updateNextLabel();
      }

      /* ========== Add custom inputs ========== */
      addCustom(ui.hobbyInput, 'hobbies', ui.hobbyChips, {icon:true, key:'hobbies'}, DEFAULT_HOBBIES);
      addCustom(ui.valueInput, 'values', ui.valueChips, {gem:true, key:'values'}, DEFAULT_VALUES);

      /* ========== Next button flow ========== */
      function updateNextLabel(){
        const d = getData();
        ui.nextEdit.textContent = d && d.completed===true ? 'Next ‚Üí Edit Profile' : 'Next ‚Üí My Soul';
      }
      ui.nextEdit.addEventListener('click', (e)=>{
        e.preventDefault();
        const d = getData();
        const firstTime = !(d && d.completed===true);
        if(firstTime){ setData({completed:true}); location.href='my-soul.html'; }
        else { location.href='edit-profile.html'; }
      });

      /* ========== Nav, drawer, logout ========== */
      const onScroll=()=>{ if(window.scrollY>6) ui.navbar.classList.add('scrolled'); else ui.navbar.classList.remove('scrolled'); };
      onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
      const openDrawer=()=>{ ui.drawer.classList.add('open'); document.body.classList.add('no-scroll'); };
      const closeDrawer=()=>{ ui.drawer.classList.remove('open'); document.body.classList.remove('no-scroll'); };
      ui.openDrawer?.addEventListener('click', openDrawer);
      ui.closeDrawer?.addEventListener('click', closeDrawer);
      ui.drawerBackdrop?.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

      ui.backHome.addEventListener('click', ()=> location.href='index.html');
      ui.logout?.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.clear(); location.href='index.html'; });
      ui.logoutM?.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.clear(); location.href='index.html'; });

      /* ========== Init ========== */
      document.addEventListener('DOMContentLoaded', ()=>{
        // prepare collapsible heights for smooth show/hide
        [ui.heightWrap, ui.weightWrap, ui.friendConnectWrap, ui.connectDetailedWrap, ui.relationshipCard, ui.orientationCard].forEach(el=>{
          if(el){ el.classList.add('collapsible'); el.style.maxHeight = el.scrollHeight+'px'; }
        });
        renderAll(); bindBasics(); bindCounters(); formatBirthOnInput();
      });

    })();
  </script>
  <script src="nav.js" defer></script>
</body>
</html>
